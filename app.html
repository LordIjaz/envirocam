<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EnviroCam Dashboard ðŸŒŠ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at center, #000000 70%, #111111 100%);
      color: #f5f5f5;
      overflow-x: hidden;
    }

    header {
      background: rgba(15, 15, 15, 0.95);
      border-bottom: 2px solid gold;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.15);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    h1 {
      color: gold;
      font-size: 1.8rem;
      margin: 0;
      text-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
    }

    #logoutBtn {
      background: linear-gradient(90deg, #b8860b, #ffd700);
      color: #000;
      border: none;
      border-radius: 0.5rem;
      padding: 0.6rem 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.3s;
    }

    #logoutBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 15px gold;
    }

    main {
      max-width: 800px;
      margin: 2rem auto;
      background: rgba(20, 20, 20, 0.95);
      border-radius: 1.2rem;
      padding: 2.5rem;
      box-shadow: 0 0 25px rgba(255, 215, 0, 0.15);
      border: 1px solid rgba(255, 215, 0, 0.2);
    }

    .user-info {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .user-info p {
      margin: 0.5rem 0;
      font-size: 1.1rem;
      color: #ccc;
    }

    .points {
      font-size: 1.4rem;
      font-weight: bold;
      color: gold;
      text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
    }

    .upload-section {
      text-align: center;
      margin-bottom: 2rem;
    }

    .upload-section h3 {
      color: gold;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
      margin-bottom: 1rem;
    }

    input[type="file"] {
      display: block;
      margin: 1rem auto;
      color: #ccc;
      background: #000;
      border: 1px solid gold;
      border-radius: 0.5rem;
      padding: 0.6rem;
      width: 80%;
      text-align: center;
      cursor: pointer;
    }

    input[type="file"]::file-selector-button {
      background: linear-gradient(90deg, #b8860b, #ffd700);
      color: #000;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 0.4rem;
      cursor: pointer;
      margin-right: 10px;
      font-weight: bold;
    }

    button {
      background: linear-gradient(90deg, #b8860b, #ffd700);
      color: #000;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 20px gold;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 1.5rem;
    }

    .gallery img {
      width: 100%;
      border-radius: 0.6rem;
      object-fit: cover;
      height: 120px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.15);
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }

    .gallery img:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px gold;
    }

    .leaderboard {
      margin-top: 2.5rem;
      text-align: center;
    }

    .leaderboard h3 {
      color: gold;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
      border-bottom: 2px solid rgba(255, 215, 0, 0.3);
      display: inline-block;
      margin-bottom: 1.2rem;
    }

    .leaderboard ul {
      list-style: none;
      padding: 0;
      margin: 0 auto;
      max-width: 400px;
    }

    .leaderboard li {
      background: rgba(30, 30, 30, 0.9);
      padding: 0.8rem 1rem;
      margin: 0.4rem 0;
      border-radius: 0.5rem;
      color: #f5f5f5;
      border: 1px solid rgba(255, 215, 0, 0.2);
      transition: box-shadow 0.3s ease, transform 0.2s ease;
    }

    .leaderboard li:hover {
      box-shadow: 0 0 10px gold;
      transform: translateY(-2px);
    }

    footer {
      text-align: center;
      color: #777;
      font-size: 0.9rem;
      margin: 2rem 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>EnviroCam ðŸŒŠ</h1>
    <button id="logoutBtn">Log Out</button>
  </header>

  <main>
    <div class="user-info">
      <p id="userEmail">Loading user...</p>
      <p class="points">Your Points: <span id="points">0</span></p>
    </div>

    <div class="upload-section">
      <h3>Upload Your Cleanup Photo ðŸ“¸</h3>
      <input type="file" id="photoUpload" accept="image/*" />
      <button id="uploadBtn">Upload</button>
      <div class="gallery" id="gallery"></div>
    </div>

    <div class="leaderboard">
      <h3>ðŸŒŽ Global Leaderboard</h3>
      <ul id="leaderboardList"></ul>
    </div>
  </main>

  <footer>Â© 2025 EnviroCam. All Rights Reserved.</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut, 
      setPersistence, 
      browserLocalPersistence 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      setDoc, 
      getDocs, 
      collection, 
      query, 
      orderBy 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDVb19bAWOOynwaYQLO4RCFoYybXkJqDRU",
      authDomain: "envirocam-5e2b4.firebaseapp.com",
      projectId: "envirocam-5e2b4",
      storageBucket: "envirocam-5e2b4.appspot.com",
      messagingSenderId: "1008928914623",
      appId: "1:1008928914623:web:0ba8c27cf1e6e45f181a0a",
      measurementId: "G-F2KSK44YT6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);

    const userEmail = document.getElementById("userEmail");
    const pointsDisplay = document.getElementById("points");
    const uploadBtn = document.getElementById("uploadBtn");
    const photoUpload = document.getElementById("photoUpload");
    const gallery = document.getElementById("gallery");
    const logoutBtn = document.getElementById("logoutBtn");
    const leaderboardList = document.getElementById("leaderboardList");

    // --- Resize image before upload ---
    function resizeImage(file, maxWidth = 300) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement("canvas");
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL("image/jpeg", 0.7));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // --- Auth state listener ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userEmail.textContent = "Signed in as: " + user.email;
        const userRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(userRef);
        if (!docSnap.exists()) {
          await setDoc(userRef, { points: 0, uploads: [], email: user.email });
          pointsDisplay.textContent = 0;
        } else {
          const data = docSnap.data();
          pointsDisplay.textContent = data.points || 0;
          renderGallery(data.uploads || []);
        }
        loadLeaderboard();
      } else {
        window.location.href = "index.html";
      }
    });

    uploadBtn.addEventListener("click", async () => {
      const file = photoUpload.files[0];
      if (!file) { alert("Select a photo first!"); return; }
      const imageData = await resizeImage(file);

      const user = auth.currentUser;
      const userRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userRef);
      let data = docSnap.data() || { points: 0, uploads: [], email: user.email };

      const newPoints = (data.points || 0) + 10;
      const newUploads = [...(data.uploads || []), imageData];

      await setDoc(userRef, { points: newPoints, uploads: newUploads, email: user.email });

      pointsDisplay.textContent = newPoints;
      renderGallery(newUploads);
      alert("Photo uploaded! +10 points ðŸª¸");
      photoUpload.value = "";
      loadLeaderboard();
    });

    function renderGallery(uploads) {
      gallery.innerHTML = "";
      uploads.forEach(img => {
        const image = document.createElement("img");
        image.src = img;
        gallery.appendChild(image);
      });
    }

    async function loadLeaderboard() {
      leaderboardList.innerHTML = "";
      const q = query(collection(db, "users"), orderBy("points", "desc"));
      const snapshot = await getDocs(q);
      snapshot.forEach(docSnap => {
        const user = docSnap.data();
        const username = user.email ? user.email.split("@")[0] : docSnap.id.substring(0,6);
        const li = document.createElement("li");
        li.textContent = `${username} â€“ ${user.points || 0} pts`;
        leaderboardList.appendChild(li);
      });
    }

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });
  </script>
</body>
</html>





